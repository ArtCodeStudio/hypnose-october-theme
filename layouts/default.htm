[staticPage]
useContent = 1
default = 0

[seoTags]

[contenteditor]
==
<?php
function onContactFormSubmit()
{
    $inputsToFill = array('contactReason', 'contactMessage', 'contactLastname', 'contactFirstname', 'contactMail', 'contactPhone', 'contactRecallTime', 'contactAgreement');
    $checkboxGroupPrefixes = array('contactRecallDay', 'contactRecallTime');
 
    $rules = [
        'contactMail' => 'required|email|between:6,255',
        'contactPhone' => 'required|between:4,255',
        'h-captcha-response' => 'required'
    ];

    $values = post();
    
    //validate input
    $validation = Validator::make($values, $rules);
    if ($validation->fails()) {
        $this->page['result'] = "Eingaben waren fehlerhaft.";
        throw new ValidationException($validation);
    }

    $data = array(
        'secret' => "0x81e3FC7577eD7aeff2a1842f267a5cc529487AAa",
        'response' => $values['h-captcha-response']
    );

    $verify = curl_init();
    curl_setopt($verify, CURLOPT_URL, "https://hcaptcha.com/siteverify");
    curl_setopt($verify, CURLOPT_POST, true);
    curl_setopt($verify, CURLOPT_POSTFIELDS, http_build_query($data));
    curl_setopt($verify, CURLOPT_RETURNTRANSFER, true);
    $response = curl_exec($verify);
    $responseData = json_decode($response);
    
    if(!$responseData->success) {
        $this->page['result'] = "Fehler beim Captcha";
        return;
    } 

    //join checkbox groups
    foreach ($checkboxGroupPrefixes as &$prefix) { //contactRecallDay
        $tempValues = array();
        foreach (array_keys($values) as $value) {
            if(strpos($value, $prefix) === 0) { //
                $tempValues[] = $values[$value];
                unset($values[$value]);
            }
        }   
        if(count($tempValues) > 0) {
            $values[$prefix] = join($tempValues, ", ");
        }
    }

    //fill missing inputs with default string
    foreach ($inputsToFill as &$inputName) {
        if(!Input::has($inputName)) {
            $values[$inputName] = 'Nicht angegeben.';    
        }
    }

    //build $from from given values
    if(Input::has('contactFirstname') && Input::has('contactLastname')) {
        $from = $values['contactFirstname'] . ' ' . $values['contactLastname'];
    } else if(Input::has('contactFirstname')) {
        $from = $values['contactFirstname'];
    } else if(Input::has('contactLastname')) {
        $from = $values['contactLastname'];
    }
    
    $buildOwnerMessage = function ($message) use ($values) {
        // TODO use email and name from backend or theme settings
        // $message->to('info@thp-garber.de', 'Viola Garber');
        $message->to('daniel@artandcode.studio', 'Daniel Omran');
        if(isset($from)) {
            $message->subject("Neue Anfrage von " . $from . " (" . $values['contactMail'] . ")");
        } else {
            $message->subject("Neue Anfrage von " . $values['contactMail']);
        }
    };
    
    $buildSenderMessage = function ($message) use ($values) {
        if(isset($from)) {
            $message->to($values['contactMail'], $from);
        } else {
            $message->to($values['contactMail']);
        }
    };

    // mail to site owner
    Mail::send('owner', $values, $buildOwnerMessage);
    
    // mail to contact sender
    Mail::send('sender', $values, $buildSenderMessage);
    
    Log::info('Used contact from user: '.$values['contactFirstname'].' '.$values['contactLastname'].' ('.$values['contactMail'].')');
    

    // TODO catch errors
    $this->page['result'] = "Nachricht abgeschickt";
    
}
?>
==
<!DOCTYPE html>
<html lang="de">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>{{ this.page.title }}</title>

    {% component 'seoTags' %}
    {% partial 'favicons' %}

    {% styles %}
    <link href="{{ ['assets/scss/theme.scss'] | theme }}" rel="stylesheet">

<body rv-data-scroll-position-y="'window'">
    <div class="page-border"></div>
    <div id="main-container">
        <div id="layout-top">
            {% partial 'layout-top' %}
        </div>
        <div id="main" rv-view="{'listenAllLinks': true, 'datasetToModel': true}">
            <div {% partial 'router-dataset' %}>
                {% if placeholder('headerTeaser') %}
                <div class="page-header-teaser">
                    {% placeholder headerTeaser title="Header Teaser" %}
                </div>
                {% endif %}
                {% if placeholder('header') %}
                <div class="page-header-container d-flex justify-content-end flex-column align-items-start">
                    {% placeholder header title="Header Title" %}
                </div>
                {% endif %}
                {# {% page %} #}
                {% component 'staticPage' %}
            </div>
        </div>
        <div id="layout-bottom">
            {% partial 'layout-bottom' %}
        </div>
        <hpn-cookies>
        </hpn-cookies>
    </div>

    {% partial 'outdated-browser' %}

    <script type="text/javascript" src="{{ 'assets/js/vendors.bundle.js' | theme }}"></script>
    <script type="text/javascript" src="{{ 'assets/js/main.bundle.js' | theme }}"></script>
    {% framework %}
    {% scripts %}

    {% partial 'provenexpert_widget_portrait' %}

</body>
</head>

</html>